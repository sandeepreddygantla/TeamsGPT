<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Fulfillment</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icons/favicon.png') }}">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()">
        <span id="sidebar-toggle-icon">‚ò∞</span>
    </button>

    <!-- Mobile Backdrop -->
    <div class="mobile-backdrop" id="mobile-backdrop" onclick="closeMobileSidebar()"></div>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-header-top">
                    <button class="sidebar-close-btn" onclick="toggleSidebar()" title="Close sidebar">
                        <span>‚úï</span>
                    </button>
                    <div class="logo">
                        <img src="{{ url_for('static', filename='icons/Optum-logo.png') }}" 
                             alt="Document Fulfillment" 
                             class="logo-image">
                        <span class="logo-text">Document Fulfillment</span>
                    </div>
                </div>
                <button class="new-chat-btn" onclick="startNewChat()">
                    <span>+</span>
                    New chat
                </button>
            </div>

            <div class="conversations-section">
                <div class="section-title">Your conversations</div>
                <button class="conversation-item active" onclick="clearChat()">
                    <span class="conversation-icon">üí¨</span>
                    Getting Started
                </button>
                <div id="conversation-list">
                    <!-- Dynamic conversation items will be added here -->
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="user-profile" onclick="showUserProfile()">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <div class="user-details">
                        <div class="user-name" id="sidebar-user-name">UHG User</div>
                        <div class="user-email" id="sidebar-user-email">user@uhg.com</div>
                    </div>
                    <div class="profile-dropdown-icon">‚öôÔ∏è</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="main-header">
                <div class="chat-title" id="chat-title">Document Fulfillment</div>
                <div class="header-center">
                    <!-- Model Selector -->
                    <div class="model-selector-container">
                        <div class="model-selector" id="model-selector">
                            <div class="model-display" onclick="toggleModelDropdown()">
                                <span class="model-icon">ü§ñ</span>
                                <span class="model-name" id="current-model-name">GPT-4o</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </div>
                            <div class="model-dropdown" id="model-dropdown">
                                <!-- Model options will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="model-status" id="model-status">
                            <span class="status-indicator"></span>
                            <span class="status-text">Ready</span>
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" title="Upload Documents" onclick="showUploadModal()">üìÅ</button>
                    <button class="icon-btn" title="Manage Documents" onclick="showDocumentManagement()">üßπ</button>
                    <button class="icon-btn" title="Statistics" onclick="showStats()">üìä</button>
                    <button class="icon-btn" title="Help" onclick="showHelp()">‚ùì</button>
                    <button class="icon-btn" title="Refresh" onclick="refreshSystem()">üîÑ</button>
                    <button class="icon-btn" title="Logout" onclick="logout()" id="logout-btn" style="display: none;">üö™</button>
                </div>
            </div>

            <div class="chat-container">
                <div class="messages-area" id="messages-area">
                    <!-- Welcome screen will be dynamically generated by JavaScript -->
                </div>

                <div class="typing-indicator" id="typing-indicator">
                    <span>AI is thinking</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>

                <div class="input-area">
                    <div class="input-container" id="input-container">
                        <div class="selected-documents" id="selected-documents"></div>
                        <textarea 
                            class="message-input" 
                            id="message-input" 
                            placeholder="What's in your mind?..."
                            rows="1"
                        ></textarea>
                        <div class="input-actions">
                            <button class="input-action-btn" title="Attach Files" onclick="showUploadModal()">
                                <svg class="paperclip-icon-svg" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M18.7103,17.5652 C20.37,15.9055 20.37,13.2145 18.7103,11.5548 L12.1696,5.01406 C11.7791,4.62353 11.7791,3.99037 12.1696,3.59984 C12.5601,3.20932 13.1933,3.20932 13.5838,3.59984 L20.1245,10.1406 C22.5653,12.5814 22.5653,16.5386 20.1245,18.9794 C17.6838,21.4202 13.7265,21.4202 11.2857,18.9794 L3.33178,11.0255 C1.57385,9.26757 1.57385,6.4174 3.33178,4.65947 C5.08971,2.90154 7.93988,2.90154 9.69781,4.65947 L17.6507,12.6123 C18.7252,13.6869 18.7252,15.429 17.6507,16.5035 C16.5762,17.578 14.834,17.578 13.7595,16.5035 L6.51272,9.2567 C6.1222,8.86617 6.1222,8.23301 6.51272,7.84248 C6.90325,7.45196 7.53641,7.45196 7.92694,7.84248 L15.1737,15.0893 C15.4672,15.3828 15.943,15.3828 16.2365,15.0893 C16.5299,14.7958 16.5299,14.32 16.2365,14.0266 L8.2836,6.07368 C7.30671,5.0968 5.72287,5.0968 4.74599,6.07368 C3.76911,7.05056 3.76911,8.6344 4.74599,9.61129 L12.6999,17.5652 C14.3596,19.2249 17.0506,19.2249 18.7103,17.5652 Z" fill="currentColor"/>
                                </svg>
                            </button>
                            <button class="send-btn" id="send-btn" onclick="sendMessage()">
                                <span>‚Üí</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Document Selection Dropdown -->
                    <div class="document-dropdown" id="document-dropdown">
                        <div class="document-dropdown-header">üìÅ Select Documents</div>
                        <div class="document-list" id="document-list">
                            <!-- Dynamic document items will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal" id="upload-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Upload Meeting Documents</div>
                <button class="close-btn" onclick="hideUploadModal()">√ó</button>
            </div>
            
            <!-- Project Selection -->
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="project-select" class="form-label">Select Project:</label>
                <select id="project-select" class="form-select">
                    <option value="">Loading projects...</option>
                </select>
                <button class="btn btn-link" onclick="showCreateProjectModal()" style="margin-left: 10px; padding: 0; font-size: 14px;">+ Create New Project</button>
            </div>
            
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Drop files here or click to upload</div>
                <div class="upload-subtext">Supports .docx, .txt, and .pdf files (max 50MB each)</div>
            </div>
            
            <input type="file" id="file-input" class="file-input" multiple accept=".docx,.txt,.pdf">
            
            <div class="uploaded-files" id="uploaded-files"></div>
            
            <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="hideUploadModal()">Cancel</button>
                <button class="btn btn-primary" id="process-btn" onclick="processFiles()" disabled>
                    Process Files
                </button>
            </div>
        </div>
    </div>

    <!-- Conversation Actions Dropdown -->
    <div class="conversation-dropdown" id="conversation-dropdown">
        <button class="dropdown-item edit" onclick="event.stopPropagation(); showEditModal()">
            <span>‚úèÔ∏è</span>
            <span>Rename</span>
        </button>
        <button class="dropdown-item delete" onclick="event.stopPropagation(); showDeleteModal()">
            <span>üóëÔ∏è</span>
            <span>Delete</span>
        </button>
    </div>

    <!-- Custom Delete Confirmation Modal -->
    <div class="custom-modal" id="delete-modal">
        <div class="custom-modal-content">
            <div class="modal-header">
                <span class="modal-icon">‚ö†Ô∏è</span>
                <span class="modal-title">Delete Conversation</span>
            </div>
            <div class="modal-message" id="delete-message">
                Are you sure you want to delete this conversation? This action cannot be undone.
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <button class="modal-btn modal-btn-delete" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Custom Edit/Rename Modal -->
    <div class="custom-modal" id="edit-modal">
        <div class="custom-modal-content">
            <div class="modal-header">
                <span class="modal-icon">‚úèÔ∏è</span>
                <span class="modal-title">Rename Conversation</span>
            </div>
            <div class="modal-message">
                Enter a new name for this conversation:
            </div>
            <input type="text" class="modal-input" id="edit-input" placeholder="Conversation name" maxlength="50">
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="modal-btn modal-btn-save" onclick="confirmEdit()">Save</button>
            </div>
        </div>
    </div>

    <!-- Create Project Modal -->
    <div class="custom-modal" id="create-project-modal">
        <div class="custom-modal-content">
            <div class="modal-header">
                <span class="modal-icon">üìÅ</span>
                <span class="modal-title">Create New Project</span>
            </div>
            <div class="modal-message">
                Enter project details:
            </div>
            <input type="text" class="modal-input" id="project-name-input" placeholder="Project name" maxlength="50">
            <textarea class="modal-input" id="project-description-input" placeholder="Project description (optional)" rows="3"></textarea>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeCreateProjectModal()">Cancel</button>
                <button class="modal-btn modal-btn-save" onclick="confirmCreateProject()">Create Project</button>
            </div>
        </div>
    </div>

    <!-- Duplicate Project Dialog -->
    <div class="custom-modal" id="duplicate-project-modal">
        <div class="custom-modal-content duplicate-dialog">
            <div class="modal-header duplicate-header">
                <span class="modal-icon duplicate-icon">‚ö†Ô∏è</span>
                <span class="modal-title">Project Name Already Exists</span>
            </div>
            <div class="modal-message duplicate-message">
                A project with the name "<strong id="duplicate-project-name"></strong>" already exists.
                <br><br>
                Please choose a different name or try one of these suggestions:
            </div>
            <div class="duplicate-suggestions" id="duplicate-suggestions">
                <!-- Suggestions will be populated dynamically -->
            </div>
            <input type="text" class="modal-input duplicate-input" id="new-project-name-input" placeholder="Enter a new project name">
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeDuplicateProjectDialog()">Cancel</button>
                <button class="modal-btn modal-btn-save duplicate-retry-btn" onclick="retryCreateProject()">Try Again</button>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div class="custom-modal" id="user-profile-modal">
        <div class="custom-modal-content user-profile-content">
            <div class="modal-header">
                <span class="modal-icon">üë§</span>
                <span class="modal-title">User Profile</span>
                <button class="close-btn" onclick="closeUserProfile()">√ó</button>
            </div>
            
            <div class="profile-section">
                <div class="profile-details">
                    <div class="profile-detail-group">
                        <label class="profile-label">Full Name</label>
                        <div class="profile-value" id="profile-full-name">UHG User</div>
                    </div>
                    
                    <div class="profile-detail-group">
                        <label class="profile-label">Username</label>
                        <div class="profile-value" id="profile-username">uhg_user</div>
                    </div>
                    
                    <div class="profile-detail-group">
                        <label class="profile-label">Email Address</label>
                        <div class="profile-value" id="profile-email">user@uhg.com</div>
                    </div>
                    
                    <div class="profile-detail-group">
                        <label class="profile-label">Account Created</label>
                        <div class="profile-value" id="profile-created-at">January 15, 2025</div>
                    </div>
                </div>
            </div>
            
            <div class="profile-stats">
                <div class="stat-item">
                    <div class="stat-value" id="stat-documents">0</div>
                    <div class="stat-label">Documents</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-conversations">0</div>
                    <div class="stat-label">Conversations</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-projects">0</div>
                    <div class="stat-label">Projects</div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="showAccountSettings()">Account Settings</button>
                <button class="modal-btn modal-btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <!-- Document Management Modal -->
    <div class="modal" id="document-management-modal">
        <div class="modal-content document-management-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="modal-icon">üßπ</span>
                    Document Management
                </div>
                <button class="close-btn" onclick="hideDocumentManagement()">√ó</button>
            </div>
            
            <div class="document-management-body">
                <!-- Search and Filter Section -->
                <div class="document-filters">
                    <div class="filter-group">
                        <input type="text" id="document-search" placeholder="Search documents..." class="search-input">
                        <select id="project-filter" class="filter-select">
                            <option value="">All Projects</option>
                        </select>
                        <button class="btn btn-secondary" onclick="refreshDocumentList()">üîÑ Refresh</button>
                    </div>
                </div>

                <!-- Storage Stats -->
                <div class="storage-stats" id="storage-stats">
                    <div class="stat-item">
                        <span class="stat-label">Total Documents:</span>
                        <span class="stat-value" id="total-docs-count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Size:</span>
                        <span class="stat-value" id="total-docs-size">0 MB</span>
                    </div>
                </div>

                <!-- Document List -->
                <div class="document-list-container">
                    <div class="document-list-header">
                        <div class="list-actions">
                            <button class="btn btn-secondary btn-sm" onclick="selectAllDocuments()">Select All</button>
                            <button class="btn btn-secondary btn-sm" onclick="clearDocumentSelection()">Clear Selection</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteSelectedDocuments()" id="delete-selected-btn" disabled>
                                üóëÔ∏è Delete Selected
                            </button>
                        </div>
                    </div>
                    
                    <div class="document-list-content" id="document-list-content">
                        <div class="loading-indicator" id="document-loading">
                            <span>Loading documents...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideDocumentManagement()">Close</button>
            </div>
        </div>
    </div>

    <!-- Document Deletion Confirmation Modal -->
    <div class="custom-modal" id="document-delete-modal">
        <div class="custom-modal-content">
            <div class="modal-header">
                <span class="modal-icon">‚ö†Ô∏è</span>
                <span class="modal-title">Delete Documents</span>
            </div>
            <div class="modal-message" id="document-delete-message">
                Are you sure you want to delete the selected document(s)? This action cannot be undone and will remove the document(s) from all storage layers including the search index.
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeDocumentDeleteModal()">Cancel</button>
                <button class="modal-btn modal-btn-delete" onclick="confirmDocumentDeletion()">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Default Project Upload Confirmation Modal -->
    <div class="custom-modal" id="default-project-upload-modal">
        <div class="custom-modal-content">
            <div class="modal-header">
                <span class="modal-icon">üìÅ</span>
                <span class="modal-title">Upload to Default Project</span>
            </div>
            <div class="modal-message" id="default-project-upload-message">
                You are uploading documents to the Default Project. Are you sure you want to continue?
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeDefaultProjectUploadModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmDefaultProjectUpload()">Continue Upload</button>
            </div>
        </div>
    </div>

    <!-- Include marked.js library for robust Markdown parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <!-- Include DOMPurify for XSS protection -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
    
    <!-- Configuration Script (must be loaded first) -->
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>
    
    <!-- Application Modules -->
    <script src="{{ url_for('static', filename='js/modules/mentions.js') }}"></script>
    
    <!-- Main Application Script -->
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>